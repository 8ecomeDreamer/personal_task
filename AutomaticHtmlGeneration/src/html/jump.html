<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet/less" type="text/css" href="../css/jump.less" />
    <!-- wangeditor -->
    <link href="https://unpkg.com/@wangeditor/editor@latest/dist/css/style.css" rel="stylesheet">
</head>

<body>
    <div class="wrapper">
        <iframe class="content" id="iframeContent" name="iframeContent" src="./tempItem1.html" frameborder="0" data-needUse=false></iframe>
        <!-- <object class="content" id="objContent" data="./tempItem2.html"></object> -->
        <!-- <content class="content"></content> -->
        <div class="operation">
            <div class="item">
                <button class="truthBtn" id="changeBackgroundBtn">更换背景图</button>
                <input id="changeBackground" type="file" accept="image/*,audio/*,video/*" class="btnInput" />
            </div>
            <!-- <button class="custom-btn" id="changeBackground" >更换背景图</button> -->
            <!-- <button class="custom-btn"  id="changeIllustrations">更换插图</button> -->
            <div class="item">
                <button class="truthBtn" id="changeIllustrationsBtn">更换插图</button>
                <input id="changeIllustrations" type="file" accept="image/*,audio/*,video/*" class="btnInput" />
            </div>
            <div class="item">
                <button id="changeWords" class="truthBtn">修改文字</button>
            </div>
            <div class="item">
                <button id="saveHtml" class="truthBtn">保存代码</button>
            </div>



        </div>

        <div class="editorWrapper" id="editor—wrapper">
            <div class="toolbarContainer" id="toolbar-container">
                <!-- 工具栏 -->
            </div>
            <div class="editorContainer" id="editor-container">
                <!-- 编辑器 -->
            </div>
            <div class="btnGroup">
                <button class="cancel">取消</button>
                <button class="confirm" data-clicked=0>确定</button>
            </div>
        </div>
    </div>


</body>

</html>
<style>

</style>

<!-- 引入 less jquery -->
<script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/2.5.3/less.min.js"></script>
<script src="https://lib.sinaapp.com/js/jquery/2.0.2/jquery-2.0.2.min.js"></script>
<!-- 引入 wangeditor  -->
<script src="https://unpkg.com/@wangeditor/editor@latest/dist/index.js"></script>

<!-- 导出 -->
<!-- <script src="https://cdn.bootcss.com/jspdf/1.5.3/jspdf.debug.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/html2canvas/0.5.0-beta4/html2canvas.js"></script> -->

<script>

    // 声明
    // 变量
    var editorTimer = null;
    var editorHtml = null;
    var setEditorHtml = '设置文本内容'
    // 判断进入的页面
    let selectPageIdx
    // var allHtml = ''
    // 确认按钮被点击次数
    let clickedTimes 

   // 选择页
   function selectHtml(selectPage) {
            console.log('正在选择html:第', selectPage, "页")
            switch (selectPage) {
                case 1:
                    $('#iframeContent').attr('src', './tempItem1.html')  // 当表达式的结果等于 value1 时，则执行该代码
                    break;
                case 2:
                    $('#iframeContent').attr('src', './tempItem2.html')  // 当表达式的结果等于 value1 时，则执行该代码
                    break;

                default:
                    $('#iframeContent').attr('src', './tempItem1.html')  // 如果没有与表达式相同的值，则执行该代码
            }
    }

    // 传给父iframe
    function toFatherFrame() {
        var useBtn = false
        return useBtn
    }

    //  防抖
    function debounce(dom, t, fn) {
        $("#dom").change(function () {
            clearTimeout(timer);
            timer = setTimeout(fn(), t)
        })
    }

    // 显示编辑器
    function showEditor() {
        // console.log($("#editor—wrapper"))
        $("#editor—wrapper").fadeToggle()
    }
    //  编辑器btnGroup事件
    function cancel() {
        $("#editor—wrapper").hide()
    }
    function confirm(idx) {
        // console.log('确定')
        console.log('editor content', editorHtml)
        
        // console.log('现在的页面值是:',selectPageIdx)
        // 添加节点和样式
        switch(idx){
            case 1:{
                // $("#iframeContent").contents().find(".box_cd .box_adxr").append(setEditorHtml)
                // $("#iframeContent").contents().find(".box_cd .box_adxr p").attr('class','txte_ocje')
                //  获取页面1的文本节点并修改

                $("#editor—wrapper").hide()
                break;
            }
            case 2:{
                // $("#iframeContent").contents().find(".box_cd .content").append(setEditorHtml)
                // .css('text-align','left').css('margin-left','10px')
                // $("#iframeContent").contents().find(".box_cd .content p").attr('class','text_ar')
                //  获取页面2的文本节点并修改

                $("#editor—wrapper").hide()
                break;
            }
        }
        
    }

    function loadWangEditor() {
        // resetHtml
        // resetHtml = resetHtml || '<p><br></p>'
        const { createEditor, createToolbar } = window.wangEditor

        const editorConfig = {
            placeholder: 'Type here...',
            onChange(editor) {
                const Html = editor.getHtml()
                // console.log('editor content', editorHtml)
                editorHtml = Html
                // debounce()

                // 也可以同步到 <textarea>
            }
        }

        const editor = createEditor({
            selector: '#editor-container',
            html: '<p><br></p>',
            config: editorConfig,
            mode: 'default', // or 'simple'
        })

        const toolbarConfig = {}

        toolbarConfig.excludeKeys = [
            "emotion",
            "insertLink",
            "group-image", // 排除菜单组，写菜单组 key 的值即可
            'group-video',
            "insertTable",
            "codeBlock",
            "divider",
            "undo",
            "redo",
            "fullScreen"

        ]

        const toolbar = createToolbar({
            editor,
            selector: '#toolbar-container',
            config: toolbarConfig,
            mode: 'default', // or 'simple'
        })
        $("#editor—wrapper").hide()
        console.log(toolbar.getConfig().toolbarKeys)


    }

    //  调用
    $(document).ready(function () {
        // 取参并转为json对象
        // 判断进入了哪个页面
        selectPageIdx = JSON.parse(localStorage.getItem('params')).selectPage
        // console.log(selectPageIdx)

        selectHtml(selectPageIdx)
        // 显示编辑器
        loadWangEditor()

        allHtml = document.getElementsByTagName('html')[0].outerHTML;

        
    })

    // 更换背景图 点击按钮实际是点击input
    // $('#changeBackgroundBtn').click(function () {
    //     $('#changeBackground').click()
    // })

    // $('#changeBackground').change(function (fileChoosed) {
    //     console.log(this.files)
    //     const reader = new FileReader();
    //     reader.readAsDataURL(fileChoosed.target.files[0]);//发起异步请求
    //     console.log(reader)
    //     reader.onload = function (e) {
    //         imgFile = e.target.result;
    //         let arr = imgFile.split(",");
    //         console.log(arr)
    //         // console.log('加载完成', readRes.target.result)
    //         $("#iframeContent").contents().find("#item").attr('background-image', 'url(' + arr[0] + arr[1] + ')')

    //     }
    // });

    // 更换背景图
    // $('#changeBackground').click (function() {
    //     // 在父页面 获取iframe子页面的元素
    //     // console.log($("#item1",document.frames('iframeContent').document))
    //     // console.log($("#iframeContent").contents().find("#item"))
    //     // $("#iframeContent").contents().find("#item").css('background', "url('../../assets/images/bg-agr.png')") 

    // }) 

    // 更换插图 点击按钮实际是点击input
    $('#changeIllustrationsBtn').click(function () {
        $('#changeIllustrations').click()
    })

    $('#changeIllustrations').change(function (fileChoosed) {
        console.log(this.files)
        const reader = new FileReader();
        reader.readAsDataURL(fileChoosed.target.files[0]);//发起异步请求
        console.log(reader)
        reader.onload = function (readRes) {
            // console.log('加载完成', readRes.target.result)
            $("#iframeContent").contents().find("#img_adx").attr('src', readRes.target.result)

        }
    });


    // 修改文字
    $('#changeWords').click(function () {

        // 判断页面
        switch(selectPageIdx){
            case 1:{
                setEditorHtml=$("#iframeContent").contents().find(".box_cd .box_adxr").html()
                editor.setHtml(setEditorHtml)
                // $("#iframeContent").contents().find(".box_cd .box_adxr p").attr('class','txte_ocje')
                //  获取页面1的文本节点并修改
                break;
            }
            case 2:{
                setEditorHtml=$("#iframeContent").contents().find(".box_cd .content").html()
                editor.setHtml(setEditorHtml)
                // .css('text-align','left').css('margin-left','10px')
                // $("#iframeContent").contents().find(".box_cd .content p").attr('class','text_ar')
                //  获取页面2的文本节点并修改
                break;
            }
        }
        // console.log ('文本内容为:',setEditorHtml)

        // 显示编辑器
        // showEditor()
        // $("#iframeContent").contents().find(".box_cd").css('color', 'red') 
    })

    $("#editor—wrapper .cancel").click(function () {
        cancel()
    })

    $("#editor—wrapper .confirm").click(function () {
        
        // let confirmTimes = $("#editor—wrapper .confirm").attr("data-clicked")
        // // // 判断是否初次点击，是先清除，否直接添加内容
        // if(confirmTimes!==0){
        //     // confirm()
        // }
        // else{
        //     // $("#iframeContent").contents().find(".box_cd").empty()
        //     // confirm()
        //     // clickedTimes+=1
        //     // $("#editor—wrapper .confirm").attr('data-clickedTimes',clickedTimes)
        // }
        console.log(selectPageIdx)
        confirm(selectPageIdx)
    })

    // 保存代码
    $("#saveHtml").click(function () {
        // saveHtmlCode()
        // daochu(allHtml)
        // console.log( $("#saveHtml"))
    })



</script>